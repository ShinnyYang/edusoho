<template>
  <div class="login">
    <span class="login-title">{{ $t('title.loginWithMobileNumber') }}</span>
    <span class="login-des">{{ $t('title.automaticallyRegistered') }}</span>
    <van-field
      v-model="userinfo.mobile"
      :border="false"
      :error-message="errorMessage.mobile"
      :placeholder="$t('placeholder.mobileNumber')"
      max-length="11"
      type="number"
      class="login-input e-input"
      clearable
      @blur="validateMobileOrPsw('mobile')"
      @keyup="validatedChecker()"
    />

    <e-drag
      v-if="dragEnable"
      ref="dragComponent"
      :key="dragKey"
      limit-type="sms_login"
      @success="handleSmsSuccess"
    />

    <van-field
      ref="smsCode"
      v-model="userinfo.smsCode"
      :border="false"
      type="number"
      center
      clearable
      max-length="6"
      class="login-input e-input"
      :placeholder="$t('placeholder.verificationCode')"
    >
      <van-button
        slot="button"
        :disabled="count.codeBtnDisable || !validated.mobile"
        size="small"
        type="primary"
        @click="clickSmsBtn"
      >
        {{ $t('btn.sendCode') }}
        <span v-show="count.showCount">({{ count.num }})</span>
      </van-button>
    </van-field>
    <van-button
      :disabled="btnDisable"
      type="default"
      class="primary-btn mb20"
      @click="handleSubmit(handleSubmitSuccess)"
      >{{ $t('btn.login') }}</van-button
    >
    <div class="login-bottom text-center">
      <div v-if="userTerms || privacyPolicy" class="login-agree">
        <van-checkbox
          v-model="agreement"
          :icon-size="16"
          checked-color="#408ffb"
        />
        {{ $t('tips.iHaveReadAndAgreeToThe') }}
        <i v-if="userTerms" @click="lookUserTerms"
          >《{{ $t('btn.userServiceAgreement') }}》</i
        >
        <span v-if="userTerms && privacyPolicy">{{ $t('tips.and') }}</span>
        <span v-if="privacyPolicy">
          <i @click="lookPrivacyPolicy">《{{ $t('btn.privacyAgreemen') }}》</i>
        </span>
      </div>
      <div class="login-change" @click="changeLogin">
        <img src="static/images/login_change.png" class="login_change-icon" />{{
          $t('btn.switchAccountPasswordToLogin')
        }}
      </div>
    </div>

    <van-popup
      v-model="popUpBottom"
      class="login-pop"
      position="bottom"
      round
      :style="{ height: '30%' }"
    >
      <div class="login-pop-title">{{ $t('btn.PleaseReadAgreeAndTerms') }}</div>
      <div v-if="userTerms || privacyPolicy" class="login-agree">
        <i v-if="userTerms" @click="lookUserTerms"
          >《{{ $t('btn.userServiceAgreement') }}》</i
        >
        <span v-if="privacyPolicy">
          <i @click="lookPrivacyPolicy">《{{ $t('btn.privacyAgreemen') }}》</i>
        </span>
      </div>
      <van-button
        :disabled="btnDisable"
        type="info"
        class="primary-btn mb20 login-pop-btn"
        @click="agreeSign(handleSubmitSuccess)"
        >{{ $t('btn.agreeAndSignin') }}</van-button
      >
    </van-popup>
  </div>
</template>
<script>
import EDrag from '&/components/e-drag';
import Api from '@/api';
import { Toast } from 'vant';
import activityMixin from '@/mixins/activity';
import redirectMixin from '@/mixins/saveRedirect';
import fastLoginMixin from '@/mixins/fastLoginWithDrag';
import { mapActions } from 'vuex';

export default {
  name: 'FastLogin',
  components: {
    EDrag,
  },
  mixins: [activityMixin, redirectMixin, fastLoginMixin],
  data() {
    return {
      userinfo: {
        mobile: '',
        dragCaptchaToken: undefined, // 默认不需要滑动验证,图片验证码token
        smsCode: '', // 验证码
        smsToken: '', // 验证码token
        type: 'sms_login',
      },
      userTerms: false, // 用户协议
      privacyPolicy: false, // 隐私协议
      registerSettings: null,
      agreement: false,
      dragEnable: true,
      dragKey: 0,
      errorMessage: {
        mobile: '',
      },
      validated: {
        mobile: false,
      },
      popUpBottom: false,
    };
  },
  computed: {
    btnDisable() {
      return !(this.userinfo.mobile && this.userinfo.smsCode);
    },
  },
  async created() {
    if (this.$store.state.token) {
      Toast.loading({
        message: this.$t('toast.pleaseWait'),
      });
      this.afterLogin();
      return;
    }
    this.getPrivacySetting();
  },
  methods: {
    ...mapActions(['addUser', 'setMobile', 'sendSmsSend', 'fastLogin']),
    async getPrivacySetting() {
      this.registerSettings = await Api.getSettings({
        query: {
          type: 'user',
        },
      })
        .then(res => {
          if (res.auth.user_terms_enabled) {
            this.userTerms = true;
          }
          if (res.auth.privacy_policy_enabled) {
            this.privacyPolicy = true;
          }
        })
        .catch(err => {
          Toast.fail(err.message);
        });
    },
    // 获取隐私政策
    lookPrivacyPolicy() {
      window.location.href =
        window.location.origin + '/mapi_v2/School/getPrivacyPolicy';
    },
    // 获取服务条款
    lookUserTerms() {
      window.location.href =
        window.location.origin + '/mapi_v2/School/getUserterms';
    },
    // 校验成功
    handleSmsSuccess(token) {
      this.userinfo.dragCaptchaToken = token;
      this.validateMobileOrPsw('mobile');
      if (this.errorMessage.mobile.length === 0) {
        this.handleSendSms();
      }
    },
    // 登录
    handleSubmitSuccess() {
      this.afterLogin();
    },

    changeLogin() {
      this.$router.push({
        name: 'login',
      });
    },
  },
};
</script>

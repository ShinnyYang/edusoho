<template>
  <div :class="{ more__still: selecting }" class="more">
    <treeSelect
      :select-items="selectItems"
      v-model="selectedData"
      @selectedChange="setQuery"
      @selectToggled="toggleHandler"
    />
    <lazyLoading
      :course-list="courseList"
      :is-all-data="isAllCourse"
      :course-item-type="courseItemType"
      :is-request-compile="isRequestCompile"
      :vip-tag-show="true"
      :type-list="'course_list'"
      @needRequest="sendRequest"
      :showNumberData="showNumberData"
    />
    <emptyCourse
      v-if="isEmptyCourse && isRequestCompile"
      :has-button="false"
      :type="'course_list'"
      text="暂无课程"
    />
  </div>
</template>

<script>
import Api from '@/api';
import treeSelect from '&/components/e-tree-select/e-tree-select.vue';
import lazyLoading from '&/components/e-lazy-loading/e-lazy-loading.vue';
import emptyCourse from '../../learning/emptyCourse/emptyCourse.vue';
import { mapState, mapActions } from 'vuex';
import CATEGORY_DEFAULT from '@/config/category-default-config.js';

export default {
  components: {
    treeSelect,
    lazyLoading,
    emptyCourse,
  },
  data() {
    return {
      selectItems: [],
      selectedData: {},
      courseItemType: 'price',
      isRequestCompile: false,
      isAllCourse: false,
      isEmptyCourse: true,
      courseList: [],
      offset: 0,
      limit: 10,
      type: 'all',
      categoryId: 0,
      sort: 'recommendedSeq',
      selecting: false,
      queryForm: {
        courseType: 'type',
        category: 'categoryId',
        sort: 'sort',
      },
      dataDefault: CATEGORY_DEFAULT.course_list,
      showNumberData: '',
    };
  },
  computed: {
    ...mapState({
      searchCourseList: state => state.course.searchCourseList,
    }),
  },
  watch: {
    selectedData() {
      const { courseList, selectedData, paging } = this.searchCourseList;

      if (this.isSelectedDataSame(selectedData)) {
        this.courseList = courseList;
        this.requestCoursesSuccess(paging);

        return;
      }

      this.initCourseList();
      const setting = {
        offset: this.offset,
        limit: this.limit,
      };
      this.requestCourses(setting);
    },
  },
  created() {
    window.scroll(0, 0);
    this.selectedData = this.transform(this.$route.query);
    // 合并参数

    // 获取班级分类数据
    Api.getCourseCategories().then(data => {
      data.unshift({
        name: '全部',
        id: '0',
      });
      this.dataDefault[0].data = data;
      this.selectItems = this.dataDefault;
    });
    this.getGoodSettings();
  },
  methods: {
    ...mapActions('course', ['setCourseList']),
    setQuery(value) {
      this.$router.replace({
        name: 'more_course',
        query: value,
      });
    },

    initCourseList() {
      this.isRequestCompile = false;
      this.isAllCourse = false;
      this.courseList = [];
      this.offset = 0;
    },

    judegIsAllCourse(paging) {
      return this.courseList.length == paging.total;
    },

    requestCourses(setting) {
      this.isRequestCompile = false;
      const config = Object.assign({}, this.selectedData, setting);
      return Api.getCourseList({
        params: config,
      })
        .then(({ data, paging }) => {
          data.forEach(element => {
            this.courseList.push(element);
          });
          this.setCourseList({
            selectedData: this.selectedData,
            courseList: this.courseList,
            paging,
          });
          this.requestCoursesSuccess(paging);
        })
        .catch(err => {
          console.log(err, 'error');
        });
    },

    requestCoursesSuccess(paging = {}) {
      this.isAllCourse = this.judegIsAllCourse(paging);
      if (!this.isAllCourse) {
        this.offset = this.courseList.length;
      }
      this.isRequestCompile = true;
      this.isEmptyCourse = this.courseList.length === 0;
    },

    sendRequest() {
      const args = {
        offset: this.offset,
        limit: this.limit,
      };

      if (!this.isAllCourse) this.requestCourses(args);
    },

    transform(obj = {}) {
      return Object.assign(
        {
          categoryId: this.categoryId,
          type: this.type,
          sort: this.sort,
        },
        obj,
      );
    },
    toggleHandler(value) {
      this.selecting = value;
    },
    isSelectedDataSame(selectedData) {
      for (const key in this.selectedData) {
        if (this.selectedData[key] != selectedData[key]) {
          return false;
        }
      }

      return true;
    },
    getGoodSettings() {
      Api.getSettings({
        query: {
          type: 'goods',
        },
      }).then(res => {
        this.showNumberData = res.show_number_data;
      });
    },
  },
};
</script>

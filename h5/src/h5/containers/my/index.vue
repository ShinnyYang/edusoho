<template>
  <div>
    <e-loading v-if="isLoading"/>
    <user/>
    <router-link :to="{name: 'couponCovert'}">
      <div v-if="hasBusinessDrainage" class="coupon-code-entrance">兑换卡券
        <i class="van-icon van-icon-arrow pull-right"/>
      </div>
    </router-link>
    <a v-if="isShowDistributorEntrance" :href="drpSetting.distributor_login_url">
      <div class="coupon-code-entrance">分销中心
        <i class="van-icon van-icon-arrow pull-right"/>
      </div>
    </a>
    <van-tabs v-model="activeIndex" class="after-tabs e-learn">
      <van-tab v-for="(item, index) in tabs" :title="item" :key="index"/>
    </van-tabs>
    <orders v-show="activeIndex === 0"/>
    <activity v-show="activeIndex === 1"/>
  </div>
</template>
<script>
import Orders from '../order/orders.vue'
import activity from './activity'
import User from './user.vue'
import { mapState } from 'vuex'
import preloginMixin from '@/mixins/preLogin'
import Api from '@/api'

export default {
  components: {
    Orders,
    activity,
    User
  },
  mixins: [preloginMixin],
  data() {
    return {
      activeIndex: 0,
      tabs: ['我的订单', '我的活动'],
      hasBusinessDrainage: false,
      isShowDistributorEntrance: false, // 是否展示分销中心入口
      drpSetting: [] // Drp设置信息
    }
  },
  computed: {
    ...mapState({
      isLoading: state => state.isLoading
    })
  },
  created() {
    setTimeout(() => {
      window.scrollTo(0, 0)
    }, 100)
    Api.hasPluginInstalled().then(res => {
      this.hasBusinessDrainage = res.BusinessDrainage
    })

    this.showDistributorEntrance()
    this.getDrpSetting()
  },
  methods: {
    showDistributorEntrance() {
      Api.hasDrpPluginInstalled().then(res => {
        if (!res.Drp) {
          this.isShowDistributorEntrance = false
          return
        }
        this.getAgencyBindRelation()
      })
    },
    getAgencyBindRelation() {
      Api.getAgencyBindRelation().then(data => {
        if (!data.agencyId) {
          this.isShowDistributorEntrance = false
          return
        }
        this.isShowDistributorEntrance = true
      })
    },
    getDrpSetting() {
      Api.getDrpSetting().then(data => {
        this.drpSetting = data
      })
    }
  }
}
</script>


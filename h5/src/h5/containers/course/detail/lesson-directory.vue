<template>
  <div>
    <template v-for="(lessonItem, lessonIndex) in lesson">
      <div v-if="hasLesson" :key="lessonIndex" class="lesson-directory">
        <div
          :id="lessonItem.tasks[lessonItem.index].id"
          :class="{ 'zb-ks': doubleLine(lessonItem.tasks[lessonItem.index]) }"
          class="lesson-title"
          @click="
            lessonCellClick(
              lessonItem.tasks[lessonItem.index],
              lessonIndex,
              lessonItem.index,
            )
          "
        >
          <div class="lesson-title-r">
            <div class="lesson-title-des">
              <!-- 非直播考试-->
              <div
                v-if="!doubleLine(lessonItem.tasks[lessonItem.index])"
                class="bl l22"
              >
                <!-- <span class="tryLes">试听</span> -->
                <span
                  :class="{
                    lessonactive:
                      currentTask == lessonItem.tasks[lessonItem.index].id,
                  }"
                  class="text-overflow ks"
                >
                  <i
                    :class="iconfont(lessonItem.tasks[lessonItem.index])"
                    class="iconfont"
                  />
                  {{
                    Number(lessonItem.tasks[lessonItem.index].isOptional)
                      ? ''
                      : '课时'
                  }}{{
                    Number(lessonItem.tasks[lessonItem.index].isOptional)
                      ? lessonItem.title
                      : `${lessonItem.tasks[lessonItem.index].number}:${
                          lessonItem.title
                        }`
                  }}
                </span>
              </div>

              <!-- 直播或者考试-->
              <div
                v-if="doubleLine(lessonItem.tasks[lessonItem.index])"
                class="bl"
              >
                <!-- <span class="tryLes">试听</span> -->
                <div class="block-inline">
                  <span
                    :class="{
                      lessonactive:
                        currentTask == lessonItem.tasks[lessonItem.index].id,
                    }"
                    class="bl text-overflow ks"
                  >
                    <i
                      :class="iconfont(lessonItem.tasks[lessonItem.index])"
                      class="iconfont"
                    />
                    {{
                      Number(lessonItem.tasks[lessonItem.index].isOptional)
                        ? ''
                        : '课时'
                    }}{{
                      Number(lessonItem.tasks[lessonItem.index].isOptional)
                        ? lessonItem.title
                        : `${lessonItem.tasks[lessonItem.index].number}:${
                            lessonItem.title
                          }`
                    }}
                  </span>
                  <span class="bl zbtime">
                    <span
                      :class="[liveClass(lessonItem.tasks[lessonItem.index])]"
                      >{{
                        lessonItem.tasks[lessonItem.index] | filterTaskTime
                      }}</span
                    >
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- 时长 -->
          <div class="lesson-title-l">
            <span
              class="elective-tag"
              v-if="Number(lessonItem.tasks[lessonItem.index].isOptional)"
            >
              选修
            </span>
            <span v-if="lessonItem.tasks[lessonItem.index].type != 'live'">{{
              lessonItem.tasks[lessonItem.index] | filterTaskTime
            }}</span>
            <i
              :class="studyStatus(lessonItem.tasks[lessonItem.index])"
              class="iconfont"
            />
          </div>
        </div>

        <!-- task任务 -->
        <div v-if="lessonItem.tasks.length > 1" class="lesson-items">
          <template v-for="(taskItem, taskIndex) in lessonItem.tasks">
            <div
              v-if="showTask(taskItem, taskIndex)"
              :id="taskItem.id"
              :key="taskIndex"
              class="litem"
              @click="lessonCellClick(taskItem, lessonIndex, taskIndex)"
            >
              <div
                :class="{ lessonactive: currentTask == Number(taskItem.id) }"
                class="litem-r text-overflow"
              >
                <!-- <span class="tryLes">试听</span> -->
                <i :class="iconfont(taskItem)" class="iconfont" />
                {{ Number(taskItem.isOptional) ? '' : '课时'
                }}{{
                  Number(taskItem.isOptional)
                    ? taskItem.title
                    : `${taskItem.number}:${taskItem.title}`
                }}
              </div>
              <div class="litem-l clearfix">
                <span :class="[liveClass(taskItem), 'text-overflow']">{{
                  taskItem | filterTaskTime
                }}</span>
                <i :class="studyStatus(taskItem)" class="iconfont" />
              </div>
            </div>
          </template>
        </div>
      </div>
    </template>
    <div v-if="isNoData" class="noneItem">
      <img src="static/images/none.png" class="notask" />
      <p>暂时还没有课时哦...</p>
    </div>
  </div>
</template>
<script>
import redirectMixin from '@/mixins/saveRedirect';
import copyUrl from '@/mixins/copyUrl';
import { mapState, mapMutations } from 'vuex';
import * as types from '@/store/mutation-types';
import { Toast } from 'vant';
export default {
  name: 'LessonDirectory',
  mixins: [redirectMixin, copyUrl],
  props: {
    lesson: {
      type: Array,
      default: () => [],
    },
    errorMsg: {
      type: String,
      default: '',
    },
    taskId: {
      type: Number,
      default: -1,
    },
    taskNumber: {
      type: Number,
      default: -1,
    },
    unitNum: {
      type: Number,
      default: -1,
    },
  },
  data() {
    return {
      currentTask: '',
    };
  },
  watch: {
    taskId: {
      handler: 'getTaskId',
      immediate: true,
    },
  },
  computed: {
    ...mapState('course', {
      details: state => state.details,
      joinStatus: state => state.joinStatus,
      selectedPlanId: state => state.selectedPlanId,
    }),
    hasLesson() {
      return this.lesson.length > 0;
    },
    isNoData() {
      // 在当前章下无节且无课时才显示
      return this.taskNumber === 0 && this.unitNum === 0;
    },
  },
  mounted() {
    if (Object.keys(this.$route.query).length) {
      const { sourceType, taskId } = this.$route.query;
      this.setSourceType({
        sourceType: sourceType,
        taskId: taskId,
      });
    }
  },
  methods: {
    ...mapMutations('course', {
      setSourceType: types.SET_SOURCETYPE,
    }),
    // 获取lesson位置
    getTaskId() {
      this.currentTask = this.taskId;
    },
    // 直播双行显示判断
    doubleLine(task) {
      if (!task.type) {
        return;
      }
      const type = task.type;
      let isDouble = false;
      if (type === 'live') {
        isDouble = true;
      } else {
        isDouble = false;
      }
      return isDouble;
    },
    showTask(taskItem, taskIndex) {
      let result = true;
      if (taskItem.mode == null) {
        if (taskIndex == 0) {
          result = false;
        }
      }
      if (taskItem.mode == 'lesson') {
        result = false;
      }
      return result;
    },
    lessonCellClick(task, lessonIndex, taskIndex) {
      this.$store.commit(types.SET_TASK_SATUS, '');
      // 课程错误和未发布状态，不允许学习任务
      if (this.errorMsg) {
        this.$emit('showDialog');
        return;
      }
      if (task.lock) {
        Toast('需要解锁上一个任务');
        return;
      }
      // 课程再创建阶段或者和未发布状态
      if (task.status === 'create' || task.status !== 'published') {
        Toast('敬请期待');
        return;
      }
      const nextTask = {
        id: task.id,
      };
      // 更改store中的当前学习
      this.$store.commit(`course/${types.GET_NEXT_STUDY}`, { nextTask });

      const details = this.details;
      !details.allowAnonymousPreview &&
        this.$router.push({
          name: 'login',
          query: {
            redirect: this.redirect,
          },
        });
      // this.joinStatus ? this.showTypeDetail(task) : '';
      if (this.joinStatus) {
        this.showTypeDetail(task);
      }
    },
    showTypeDetail(task) {
      if (task.status !== 'published') {
        Toast('敬请期待');
        return;
      }
      switch (task.type) {
        case 'video':
          if (task.mediaSource === 'self') {
            this.setSourceType({
              sourceType: 'video',
              taskId: task.id,
            });
          } else {
            Toast('暂不支持此类型');
          }
          break;
        case 'audio':
          this.setSourceType({
            sourceType: 'audio',
            taskId: task.id,
          });
          break;
        case 'text':
        case 'ppt':
        case 'doc':
          this.$router.push({
            name: 'course_web',
            query: {
              courseId: this.selectedPlanId,
              taskId: task.id,
              type: task.type,
            },
          });
          break;
        case 'live': {
          const nowDate = new Date();
          const endDate = new Date(task.endTime * 1000);
          let replay = false;
          if (nowDate > endDate) {
            if (task.activity.replayStatus == 'videoGenerated') {
              // 本站文件
              if (task.mediaSource === 'self') {
                this.setSourceType({
                  sourceType: 'video',
                  taskId: task.id,
                });
              } else {
                Toast('暂不支持此类型');
              }
              return;
            } else if (task.activity.replayStatus == 'ungenerated') {
              Toast('暂无回放');
              return;
            } else {
              replay = true;
            }
          }
          this.$router.push({
            name: 'live',
            query: {
              courseId: this.selectedPlanId,
              taskId: task.id,
              type: task.type,
              title: task.title,
              replay,
            },
          });
          break;
        }
        case 'testpaper': {
          const testId = task.activity.testpaperInfo.testpaperId;
          this.$router.push({
            name: 'testpaperIntro',
            query: {
              testId: testId,
              targetId: task.id,
            },
          });
          break;
        }
        case 'homework':
          this.$router.push({
            name: 'homeworkIntro',
            query: {
              courseId: this.$route.params.id,
              taskId: task.id,
            },
          });
          break;
        case 'exercise':
          this.$router.push({
            name: 'exerciseIntro',
            query: {
              courseId: this.$route.params.id,
              taskId: task.id,
            },
          });
          break;
        default:
          // 防止视频遮挡了弹出框
          this.setSourceType({
            sourceType: 'img',
            taskId: task.id,
          });
          this.copyPcUrl(task.courseUrl);
      }
    },
    // 任务图标(缺少下载)
    iconfont(task) {
      const type = task.type;
      switch (type) {
        case 'audio':
          return 'icon-yinpin';
        case 'doc':
          return 'icon-wendang';
        case 'exercise':
          return 'icon-lianxi';
        case 'flash':
          return 'icon-flash';
        case 'homework':
          return 'icon-zuoye';
        case 'live':
          return 'icon-zhibo';
        case 'ppt':
          return 'icon-ppt';
        case 'discuss':
          return 'icon-taolun';
        case 'testpaper':
          return 'icon-kaoshi';
        case 'text':
          return 'icon-tuwen';
        case 'video':
          return 'icon-shipin';
        case 'download':
          return 'icon-xiazai';
        default:
          return '';
      }
    },
    // 学习状态
    studyStatus(task) {
      if (task.lock) {
        return 'icon-suo';
      }
      if (task.result != null) {
        switch (task.result.status) {
          case 'finish':
            return 'icon-yiwanchengliang';
          case 'start':
            return 'icon-weiwancheng';
          default:
            return '';
        }
      } else {
        return 'icon-weixuexi';
      }
    },
    // 直播状态样式
    liveClass(lesson) {
      if (lesson.status != 'published' || lesson.type != 'live') {
        return 'nopublished';
      }
      const now = new Date().getTime();
      const endTimeStamp = new Date(lesson.endTime * 1000);
      if (now > endTimeStamp) {
        if (lesson.activity.replayStatus === 'ungenerated') {
          return 'end';
        }
        return 'back';
      }
      return 'play';
    },
  },
};
</script>

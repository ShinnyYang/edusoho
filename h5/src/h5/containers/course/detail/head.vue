<template>
  <div id="course-detail__head" class="course-detail__head pos-rl">
    <video-report-mask
      :type="outFocusMaskType"
      :isShow="isShowOutFocusMask"
      :reportType="reportType"
      @outFocusMask="outFocusMask"
    ></video-report-mask>
    <div
      v-if="textContent"
      v-show="
        ['audio'].includes(sourceType) && !isEncryptionPlus && !isCoverOpen
      "
      class="course-detail__nav--btn"
      @click="viewAudioDoc"
    >
      文稿
    </div>
    <div
      v-if="textContent"
      v-show="['audio'].includes(sourceType) && !isEncryptionPlus"
      :class="{ opened: isCoverOpen }"
      class="course-detail__nav--cover web-view"
    >
      <div class="media-text" v-html="textContent" />
      <div
        v-show="isCoverOpen"
        class="course-detail__nav--cover-control"
        @click="handlePlayer"
      >
        <i
          :class="!isPlaying ? 'icon-bofang' : 'icon-zanting'"
          class="iconfont"
        />
      </div>
      <div class="course-detail__nav--cover-close-btn" @click="hideAudioDoc">
        <i class="van-icon van-icon-arrow van-nav-bar__arrow" />
      </div>
    </div>
    <div
      v-show="sourceType === 'img' || isEncryptionPlus || finishDialog"
      id="course-detail__head--img"
      class="course-detail__head--img"
    >
      <img v-if="courseSet.cover" :src="courseSet.cover.large" alt />
      <countDown
        v-if="
          seckillActivities &&
            seckillActivities.status === 'ongoing' &&
            counting &&
            !isEmpty
        "
        :activity="seckillActivities"
        @timesUp="expire"
        @sellOut="sellOut"
      />
      <div class="wechat-subscribe">
        <wx-open-subscribe
          template="gd7YkJSa2zh5k0z7O3PBPMosQmGS6zex8bumXbzHg5U"
          id="subscribe-btn"
        >
          <script type="text/wxtag-template" slot="style">
            <style>
              .subscribe-btn {
                color: #fff;
              }

              .subscribe-btn svg {
                width: 20px;
                height: 20px;
              }
            </style>
          </script>
          <script type="text/wxtag-template">
            <span class="subscribe-btn">
              <svg t="1619420533012" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2825" width="128" height="128"><path d="M451.541333 322.154667l-66.986666 12.138666-2.816 0.64c-22.997333 6.250667-31.552 35.242667-14.592 52.970667l47.061333 49.173333-9.173333 67.498667-0.234667 2.688c-1.322667 23.893333 23.701333 41.130667 45.866667 30.442667l61.312-29.568 61.354666 29.568 2.474667 1.066666c22.336 8.661333 46.442667-9.813333 43.136-34.197333l-9.173333-67.498667 47.082666-49.173333 1.92-2.176c14.933333-18.56 4.8-47.061333-19.328-51.434667l-67.008-12.138666-32.256-59.968c-12.074667-22.464-44.288-22.464-56.362666 0L451.541333 322.133333zM512 344.874667l11.370667 21.162666 1.664 2.773334a32 32 0 0 0 20.821333 13.568l23.616 4.266666-16.597333 17.365334-2.112 2.432a32 32 0 0 0-6.464 24l3.221333 23.765333-21.632-10.410667-2.986667-1.258666a32 32 0 0 0-24.789333 1.28l-21.653333 10.389333 3.242666-23.765333 0.277334-3.221334a32 32 0 0 0-8.853334-23.210666l-16.618666-17.365334 23.637333-4.266666a32 32 0 0 0 22.485333-16.341334l11.370667-21.162666z" fill="#666666" p-id="2826"></path><path d="M768 53.333333H256A117.333333 117.333333 0 0 0 138.666667 170.666667v688.917333a74.666667 74.666667 0 0 0 115.669333 62.4l252.202667-165.717333a10.666667 10.666667 0 0 1 11.733333 0l251.306667 165.546666a74.666667 74.666667 0 0 0 115.754666-62.336V170.666667A117.333333 117.333333 0 0 0 768 53.333333z m-512 64h512A53.333333 53.333333 0 0 1 821.333333 170.666667v688.810666a10.666667 10.666667 0 0 1-16.533333 8.896l-251.349333-165.546666a74.666667 74.666667 0 0 0-82.069334-0.042667L219.2 868.48a10.666667 10.666667 0 0 1-16.533333-8.917333V170.666667A53.333333 53.333333 0 0 1 256 117.333333z" fill="#666666" p-id="2827"></path></svg>
              订阅
            </span>
          </script>
        </wx-open-subscribe>
      </div>
    </div>
    <!-- 由于在安卓端弹出层会被视频遮挡，因此在弹出层显示时，隐藏视频，显示课程封面图，判断字段 finishDialog-->
    <div v-show="!isShowOutFocusMask">
      <div
        v-show="
          ['video', 'audio'].includes(sourceType) &&
            !isEncryptionPlus &&
            !finishDialog
        "
        id="course-detail__head--video"
        ref="video"
      />
    </div>
    <!-- 学习上报按钮 -->
    <template v-if="showLearnBtn">
      <div
        v-if="isFinish"
        class="course-detail__head--btn course-detail__head--activebtn"
      >
        <i class="iconfont icon-markdone"></i>
        学过了
      </div>

      <div v-if="!isFinish">
        <div
          class="course-detail__head--btn"
          v-if="enableFinish"
          @click="toLearned"
        >
          学过了
        </div>
        <div
          class="course-detail__head--btn"
          v-if="!enableFinish"
          @click="toToast"
        >
          完成条件
        </div>
      </div>
    </template>
    <!-- 学习上报按钮 -->

    <tagLink :tag-data="tagData" />
    <finishDialog
      v-if="finishDialog"
      :finishResult="finishResult"
      :courseId="selectedPlanId"
      @closeFinishDialog="closeFinishDialog"
    ></finishDialog>
  </div>
</template>
<script>
import loadScript from 'load-script';
import { mapState, mapActions } from 'vuex';
import Api from '@/api';
import { Toast, Dialog } from 'vant';
import countDown from '&/components/e-marketing/e-count-down/index';
import tagLink from '&/components/e-tag-link/e-tag-link';
import finishDialog from '../components/finish-dialog';
import qs from 'qs';
import report from '@/mixins/course/report';
import VideoReportMask from '@/components/video-report-mask';
import initSubscribe from '@/utils/wechat-subscribe.js';

export default {
  components: {
    countDown,
    tagLink,
    finishDialog,
    VideoReportMask,
  },
  mixins: [report],
  props: {
    courseSet: {
      type: Object,
      default: () => {
        return {};
      },
    },
    seckillActivities: {
      type: Object,
      default: null,
    },
  },
  data() {
    return {
      finishCondition: undefined,
      learnMode: false,
      enableFinish: false,
      isEncryptionPlus: false,
      isCoverOpen: false,
      isPlaying: false,
      player: null,
      counting: true,
      isEmpty: false,
      textContent: null,
      tagData: {
        // 分销标签信息
        earnings: 0,
        isShow: false,
        link: '',
        className: 'course-tag',
        minDirectRewardRatio: 0,
      },
      timeChangingList: [],
      bindAgencyRelation: {}, // 分销代理商绑定信息
      finishResult: null,
      finishDialog: false, // 下一课时弹出模态框
      lastWatchTime: 0, // 上一次暂停上报的视频时间
      nowWatchTime: 0, // 当前刚看时间计时
    };
  },
  computed: {
    ...mapState(['DrpSwitch', 'cloudSdkCdn']),
    ...mapState('course', {
      sourceType: state => state.sourceType,
      selectedPlanId: state => state.selectedPlanId,
      taskId: state => state.taskId,
      details: state => state.details,
      joinStatus: state => state.joinStatus,
      user: state => state.joinStatus?.user || {},
      allTask: state => state.allTask,
    }),
    showLearnBtn() {
      return this.joinStatus && ['video', 'audio'].includes(this.sourceType);
    },
  },
  watch: {
    taskId(value, oldValue) {
      // 未登录情况下，详情页面不需要初始化播放器
      if (this.$route.name === 'course' && !this.joinStatus) return;
      if (value > 0) {
        this.initHead();
      }
    },
    selectedPlanId(value) {
      // 未登录情况下，详情页面不需要初始化播放器
      if (this.$route.name === 'course' && !this.joinStatus) return;
      if (value > 0) {
        this.initHead();
      }
    },
  },
  created() {
    this.initHead();
    this.showTagLink();
    this.initSubscribe();
  },
  beforeDestroy() {
    if (this.sign.length > 0) {
      localStorage.setItem('flowSign', this.sign);
    }
    // 销毁播放器
    if (this.player && this.player.destory) {
      this.player.destory();
    }
    // 清除计时器
    this.clearComputeWatchTime();
  },
  /*
   * 试看需要传preview=1
   * eg: /api/courses/1/task_medias/1?preview=1
   */
  methods: {
    ...mapActions(['setCloudAddress']),

    initSubscribe,

    toToast() {
      const condition = this.finishCondition;
      if (!condition) return;
      let message = '';
      if (['time', 'watchTime'].includes(condition.type)) {
        const minute = Math.ceil((condition.data * 60 - this.learnedTime) / 60);
        message =
          minute > 0 ? `\n剩余 ${minute} 分完成` : '\n恭喜！你已完成该任务';
      }
      this.$toast({
        message: `完成条件：${condition.text}${message}`,
        position: 'bottom',
      });
    },
    isAndroid() {
      return !!navigator.userAgent.match(new RegExp('android', 'i'));
    },
    initHead() {
      if (['video', 'audio'].includes(this.sourceType)) {
        window.scrollTo(0, 0);
        if (this.joinStatus) {
          this.initReport();
          this.clearComputeWatchTime();
          this.lastWatchTime = 0;
          this.nowWatchTime = 0;
        }
        this.initData();
      }
    },
    initReport() {
      this.finishDialog = false;
      this.getFinishCondition();
      this.IsLivePlayback();
    },
    getFinishCondition() {
      this.getCourseData(this.selectedPlanId, this.taskId).then(res => {
        this.finishCondition = res.activity && res.activity.finishCondition;
      });
    },
    // 直播视频回放刚进入课程就算学习完成
    IsLivePlayback() {
      if (this.allTask[this.taskId].type === 'live') {
        this.reprtData({ eventName: 'finish' });
      }
    },
    viewAudioDoc() {
      this.isCoverOpen = true;
    },
    hideAudioDoc() {
      this.isCoverOpen = false;
    },
    handlePlayer() {
      if (this.isPlaying) {
        return this.player && this.player.pause();
      }
      return this.player && this.player.play();
    },
    getParams() {
      const canTryLookable = !this.joinStatus;
      return canTryLookable
        ? {
            query: {
              courseId: this.selectedPlanId,
              taskId: this.taskId,
            },
            params: {
              preview: 1,
              version: 'escloud',
            },
          }
        : {
            query: {
              courseId: this.selectedPlanId,
              taskId: this.taskId,
            },
            params: {
              version: 'escloud',
            },
          };
    },
    initData() {
      this.isShowOutFocusMask = false;
      if (this.sign.length > 0) {
        localStorage.setItem('flowSign', this.sign);
        this.sign = '';
      }
      this.$refs.video && (this.$refs.video.innerHTML = '');
      // 是否为无限制任务
      this.enableFinish = !!parseInt(this.details.enableFinish);
      // 销毁播放器
      if (this.player && this.player.destory) {
        this.player.destory();
      }
      this.getData();
    },
    getData() {
      Api.getMedia(this.getParams())
        .then(async res => {
          const {
            media: { resNo },
            mediaType,
          } = res;

          if (resNo === '0') {
            const media = await Api.getLocalMediaLive({
              query: {
                taskId: this.taskId,
              },
              params: {
                hls_encryption: 1,
              },
            });
            delete res.media.resNo;
            res.media.url = media.mediaUri;
          }
          if (mediaType === 'audio') {
            this.formateAudioData(res);
            return;
          }
          if (mediaType === 'video') {
            this.formateVedioData(res);
          }
        })
        .catch(err => {
          const courseId = Number(this.details.id);
          // 后台课程设置里设置了不允许未登录用户观看免费试看的视频
          if (err.code == 4040101) {
            this.$router.push({
              name: 'login',
              query: {
                redirect: `/course/${courseId}`,
              },
            });
          }
          Toast.fail(err.message);
        });
    },
    formateAudioData(player) {
      const media = player.media;
      if (!media.isFinishConvert) {
        Toast('课程内容准备中，请稍候查看');
        return;
      }
      // 不支持浏览器判断
      this.isEncryptionPlus = media.isEncryptionPlus;
      if (media.isEncryptionPlus) {
        Toast('该浏览器不支持云视频播放，请下载App');
        return;
      }
      // 音频文稿
      this.textContent = media.text;
      const options = {
        id: 'course-detail__head--video',
        user: this.user,
        resNo: media.resNo,
        token: media.token,
        autoplay: true,
        disableDataUpload: true,
        watermark: {
          pos: 'top.right',
          width: 30,
          height: 30,
        },
        rememberLastPos: true,
        playlist: media.url,
      };
      this.$store.commit('UPDATE_LOADING_STATUS', true);
      this.initPlayer(options);
    },
    formateVedioData(player) {
      const media = player.media;
      const timelimit = media.timeLimit;
      // 视频试看判断
      const canTryLookable =
        !this.joinStatus && Number(this.details.tryLookable);
      // 不支持浏览器判断
      if (!media.isFinishConvert) {
        Toast('课程内容准备中，请稍候查看');
        return;
      }
      this.isEncryptionPlus = media.isEncryptionPlus;
      if (media.isEncryptionPlus) {
        Toast('该浏览器不支持云视频播放，请下载App');
        return;
      }

      const options = {
        id: 'course-detail__head--video',
        user: this.user,
        autoplay: true,
        disableFullscreen: this.sourceType === 'audio',
        strictMode: !media.supportMobile, // 视频是否加密 1表示普通  0表示加密
        pluck: {
          timelimit: timelimit,
        },
        resNo: media.resNo,
        disableDataUpload: true,
        watermark: {
          pos: 'top.right',
          width: 30,
          height: 30,
        },
        token: media.token,
        rememberLastPos: true,
        playlist: media.url,
      };

      if (!canTryLookable) {
        delete options.pluck;
      }
      this.$store.commit('UPDATE_LOADING_STATUS', true);
      this.initPlayer(options);
    },
    async initPlayer(options) {
      if (!this.cloudSdkCdn) {
        await this.setCloudAddress();
      }
      const playerSDKUri =
        `//${this.cloudSdkCdn}/js-sdk-v2/sdk-v1.js?` +
        ~~(Date.now() / 1000 / 60);
      loadScript(playerSDKUri, err => {
        this.$store.commit('UPDATE_LOADING_STATUS', false);
        if (err) throw err;
        const player = new window.QiQiuYun.Player(options);
        this.player = player;
        player.on('unablePlay', () => {
          // 加密模式下在不支持的浏览器下提示
          this.$refs.video.innerHTML = '';
          Dialog.alert({
            message:
              '当前内容不支持该手机浏览器观看，建议您使用Chrome、Safari浏览器观看。',
          }).then(() => {});
        });
        player.on('ready', () => {
          this.initReportData(
            this.selectedPlanId,
            this.taskId,
            this.sourceType,
          );
        });
        player.on('playing', () => {
          this.isPlaying = true;
          this.clearComputeWatchTime();
          this.computeWatchTime();
        });
        player.on('paused', e => {
          this.isPlaying = false;
          this.clearComputeWatchTime();
          this.reprtData({
            eventName: 'doing',
            ContinuousReport: true,
          });
        });
        player.on('ended', () => {
          this.clearComputeWatchTime();
          if (this.finishCondition && this.finishCondition.type === 'end') {
            this.reprtData({ eventName: 'finish' });
          }
        });
      });
    },
    expire() {
      this.counting = false;
    },
    sellOut() {
      this.isEmpty = true;
      this.$emit('goodsEmpty');
    },
    showTagLink() {
      if (!this.DrpSwitch) {
        this.tagData.isShow = false;
        return;
      }
      this.initTagData();
      this.getAgencyBindRelation();
    },
    getAgencyBindRelation() {
      Api.getAgencyBindRelation().then(data => {
        if (!data.agencyId) {
          this.tagData.isShow = false;
          return;
        }
        this.bindAgencyRelation = data;
        this.tagData.isShow = true;
      });
    },
    initTagData() {
      Api.getDrpSetting().then(data => {
        this.drpSetting = data;
        this.tagData.minDirectRewardRatio = data.minDirectRewardRatio;

        const params = {
          type: 'course',
          id: this.details.id,
          merchant_id: this.drpSetting.merchantId,
        };

        this.tagData.link =
          this.drpSetting.distributor_template_url + '?' + qs.stringify(params);
        const earnings =
          (this.drpSetting.minDirectRewardRatio / 100) * this.details.price;
        this.tagData.earnings = (Math.floor(earnings * 100) / 100).toFixed(2);
      });
    },
    toLearned() {
      this.reprtData({ eventName: 'finish' }).then(res => {
        this.finishResult = res;
        this.finishDialog = true;
      });
    },
    // 计算观看时长计时器，一直累加 nowWatchTime
    computeWatchTime() {
      this.intervalWatchTime = setInterval(() => {
        this.nowWatchTime++;
      }, 1000);
    },
    // 清除计时器
    clearComputeWatchTime() {
      clearInterval(this.intervalWatchTime);
      this.intervalWatchTime = null;
    },
    closeFinishDialog() {
      this.finishDialog = false;
    },
  },
};
</script>

<template>
  <div class="module-template" @click="activeModule">
    <!-- 基础组件——轮播 -->
    <carousel
      v-if="module.type === moduleDefault.slideShow.type"
      :active="isActive"
      :moduleData="module"
      :incomplete="validateFuc"
      @updateModule="updateHandler(module, index)"
    ></carousel>

    <!-- 基础组件——课程列表 -->
    <course
      v-if="module.type === moduleDefault.courseList.type"
      :key="1"
      :active="isActive"
      :moduleData="module"
      :incomplete="validateFuc"
      @updateModule="updateHandler(module, index)"
    ></course>

    <!-- 班级列表 -->
    <course
      v-if="module.type === moduleDefault.classList.type"
      :key="2"
      :active="isActive"
      :moduleData="module"
      :incomplete="validateFuc"
      @updateModule="updateHandler(module, index)"
    ></course>

    <!-- 广告海报 -->
    <poster
      v-if="module.type === moduleDefault.poster.type"
      :active="isActive"
      :moduleData="module"
      :incomplete="validateFuc"
      @updateModule="updateHandler(module, index)"
    ></poster>

    <!-- 优惠券 -->
    <coupon
      v-if="module.type === moduleDefault.coupon.type"
      :active="isActive"
      :moduleData="module"
      :incomplete="validateFuc"
      @updateModule="updateHandler(module, index)"
    ></coupon>

    <!-- 会员 -->
    <vip
      v-if="module.type === moduleDefault.vip.type"
      :active="isActive"
      :moduleData="module"
      :incomplete="validateFuc"
      @updateModule="updateHandler(module, index)"
    ></vip>

  <!-- 仅app有的基础组件 -->
  <!-- 图文导航 -->
     <graphic-navigation
      v-if="module.type === moduleDefault.graphicNavigation.type"
      :active="isActive"
      :moduleData="module"
      :incomplete="validateFuc"
      @updateModule="updateHandler(module, index)"
    ></graphic-navigation>

  <!-- 公开课 -->
    <open-course
      v-if="module.type === moduleDefault.openCourseList.type"
      :key="3"
      :active="isActive"
      :moduleData="module"
      :incomplete="validateFuc"
      @updateModule="updateHandler(module, index)"
    ></open-course>

    <!-- 营销组件——拼团，砍价，秒杀 -->
    <marketing-activity
      v-if="[moduleDefault.groupon.type, moduleDefault.cut.type, moduleDefault.seckill.type].includes(module.type)"
      :active="isActive"
      :moduleData="module"
      :incomplete="validateFuc"
      :key="index"
      @updateModule="updateHandler(module, index)"
    ></marketing-activity>
    <img
      class="icon-delete"
      src="static/images/delete.png"
      @click="handleRemove(module, index)"
      v-show="isActive"
    />
  </div>
</template>

<script>
import Carousel from "../carousel";
import Course from "../course";
import OpenCourse from "../open-course";
import GraphicNavigation from "../graphic-navigation";
import Poster from "../poster";
import Coupon from "../coupon";
import Vip from "../vip";
import MarketingActivity from "../marketing-activity";
import validate from "admin/utils/module-validator";
import { MODULE_DEFAULT } from "admin/config/module-default-config";

export default {
  components: {
    carousel: Carousel,
    course: Course,
    poster: Poster,
    "marketing-activity": MarketingActivity,
    coupon: Coupon,
    vip: Vip,
    openCourse:OpenCourse,
    graphicNavigation:GraphicNavigation
  },
  props: {
    module: {
      type: Object,
      default: () => {
        return {};
      }
    },
    active: {
      type: Boolean,
      default: true
    },
    index: {
      type: Number,
      default: 0
    },
    moduleKey: {
      type: String,
      default: "demo-1"
    },
    saveFlag: {
      type: Number,
      default: 0
    },
    startValidate:{
      type: Boolean,
      default: false
    }
  },
  computed: {
    isActive: {
      get() {
        return this.active;
      },
      set() {
        if (this.active) return;
        this.$emit("activeModule", this.index);
      }
    },
    validateFuc() {
      if (this.saveFlag) {
        return validate(this.module);
      }
    }
  },
  watch: {
    saveFlag(value) {
      if (!value) return;
      this.triggerValidate();
    }
  },
  created() {
    // 每个模块唯一值
    this.module.moduleType = this.moduleKey;
    this.triggerValidate();
  },
  updated() {
    // 每个模块唯一值
    this.module.moduleType = this.moduleKey;
  },
  data() {
    return {
      incomplete: false,
      moduleDefault: MODULE_DEFAULT
    };
  },
  methods: {
    activeModule() {
      this.isActive = true;
    },
    updateHandler() {},
    triggerValidate() {
      if (this.module.type === "poster") {
        const linkData = this.module.data.link;
        if (linkData.type === "url") {
          linkData.target = null;
        } else {
          linkData.url = "";
        }
      }
      const incomplete = validate(this.module, this.startValidate);
      this.$emit("updateModule", {
        incomplete,
        updateModule: this.module
      });
    },
    handleRemove(data, index) {
      this.$emit("removeModule", data);
    }
  }
};
</script>

<template>
  <div>
    <div class="help-block" v-if="portal === 'miniprogram'"></div>
    <div
      class="setting-page"
      :class="{
        'setting-page-miniprogram':
          portal === 'miniprogram' && supportActivityVersion,
      }"
    >
      <img class="find-head-img" :src="headImg" alt="" />
      <div class="find-navbar" :class="`find-navbar-${portal}`">
        <i v-if="portal === 'apps'" class="iconfont icon-search"></i>
        <i class="h5-icon h5-icon-houtui"></i>{{ headTitle }}
      </div>

      <!-- 操作预览区域 -->
      <div class="find-body">
        <draggable
          v-model="modules"
          :options="{
            filter: stopDraggleClasses,
            preventOnFilter: false,
          }"
        >
          <module-template
            v-for="(module, index) in modules"
            :key="index"
            :saveFlag="saveFlag"
            :startValidate="startValidate"
            :index="index"
            :module="module"
            :active="isActive(index)"
            :moduleKey="`${module.type}-${index}`"
            @activeModule="activeModule"
            @updateModule="updateModule($event, index)"
            @removeModule="removeModule($event, index)"
          >
          </module-template>
        </draggable>
      </div>

      <!--h5和小程序 底部添加组件按钮 -->
      <div
        class="multi-find-section find-section clearfix"
        v-if="portal !== 'apps'"
      >
        <div class="section-title">基础组件</div>
        <div class="section-button-group clearfix">
          <el-button
            class="find-section-item"
            type=""
            size="medium"
            @click="addModule(item, index)"
            v-for="(item, index) in baseModules"
            :key="`base-${index}`"
          >
            {{ item.name }}
          </el-button>
        </div>
        <template>
          <div class="section-title">
            营销组件
            <a
              class="color-primary pull-right text-12"
              :href="createMarketingUrl"
              target="_blank"
              >创建活动&gt;&gt;</a
            >
          </div>
          <div class="section-button-group clearfix">
            <el-button
              class="find-section-item"
              type=""
              size="medium"
              @click="addModule(item, index)"
              v-for="(item, index) in marketingModules"
              :key="`marketing-${index}`"
            >
              {{ item.name }}
            </el-button>
          </div>
        </template>
      </div>

      <!-- App  底部添加组件按钮-->
      <div
        class="multi-find-section find-section clearfix"
        v-if="portal === 'apps'"
      >
        <div class="section-title">基础组件</div>
        <div class="section-button-group clearfix">
          <el-button
            class="find-section-item"
            type=""
            size="medium"
            @click="addModule(item, index)"
            v-for="(item, index) in appBaseModules"
            :key="`app-base-${index}`"
          >
            {{ item.name }}
          </el-button>
        </div>
      </div>

      <find-footer :portal="portal"></find-footer>
    </div>

    <!-- 发布预览按钮 -->
    <div class="setting-button-group">
      <el-button
        class="setting-button-group__button text-14 btn-border-primary"
        size="mini"
        @click="reset"
        :disabled="isLoading"
        >重 置</el-button
      >
      <el-button
        class="setting-button-group__button text-14 btn-border-primary"
        size="mini"
        @click="save('draft')"
        :disabled="isLoading"
        >预 览</el-button
      >
      <el-button
        class="setting-button-group__button text-14"
        type="primary"
        size="mini"
        @click="save('published')"
        :disabled="isLoading"
        >发 布</el-button
      >
    </div>
  </div>
</template>
<script>
import Api from 'admin/api';
import * as types from 'admin/store/mutation-types';
import {
  BASE_MODULE,
  MARKETING_MODULE,
  APP_BASE_MODULE,
} from 'admin/config/module-default-config';
import ModuleCounter from 'admin/utils/module-counter';
import needUpgrade from 'admin/utils/version-compare';
import pathName2Portal from 'admin/config/api-portal-config';
import marketingMixins from 'admin/mixins/marketing';
import ObjectArray2ObjectByKey from '@/utils/array2object';
import moduleTemplate from './module-template';
import findFooter from './footer';
import draggable from 'vuedraggable';
import { mapActions, mapState } from 'vuex';

export default {
  components: {
    moduleTemplate,
    draggable,
    findFooter,
  },
  mixins: [marketingMixins],
  data() {
    return {
      title: 'EduSoho 微网校',
      modules: [],
      // 保存标志，只有点击过保存或者预览按钮才开始实时校验，具体表现错误模块为有错误模块边框变红提示！。这里设置成为数字原因是：每次点击发布或者预览按钮时都需要去实时校验一次，
      saveFlag: 0,
      // 非空提示，在点击发布或者预览按钮时才需要提示，具体表现为弹窗提示
      startValidate: false,
      incomplete: true,
      validateResults: [],
      currentModuleIndex: '0',
      baseModules: BASE_MODULE,
      marketingModules: MARKETING_MODULE,
      appBaseModules: APP_BASE_MODULE,
      typeCount: {},
      pathName: this.$route.name,
      currentMPVersion: '0.0.0',
      couponSwitch: 0,
      moduleLength: 0,
    };
  },
  computed: {
    ...mapState([
      'isLoading',
      'vipLevels',
      'vipSettings',
      'vipSetupStatus',
      'vipPlugin',
      'settings',
    ]),
    stopDraggleClasses() {
      return (
        '.module-frame__setting, .find-footer,' +
        '.search__container, .el-dialog__header, .el-dialog__footer'
      );
    },
    portal() {
      return pathName2Portal[this.pathName];
    },
    supportActivityVersion() {
      return true;
      // return this.supportVersion('1.3.7');
    },
    supportClassroomVersion() {
      return true;
      // return this.supportVersion('1.3.1');
    },
    supportCouponVersion() {
      return true;
      // return this.supportVersion('1.3.2');
    },
    supportVipVersion() {
      return this.vipSetupStatus;
      // return this.supportVersion('1.3.4') && this.vipSetupStatus;
    },
    headImg() {
      switch (this.portal) {
        case 'miniprogram':
          return 'static/images/miniprogram_head.jpg';
        case 'apps':
          return 'static/images/app_head.jpg';
        default:
          return 'static/images/find_head_url.jpg';
      }
    },
    headTitle() {
      switch (this.portal) {
        case 'miniprogram':
          return '小程序';
        case 'apps':
          return this.settings.name;
        default:
          return '微网校';
      }
    },
  },
  created() {
    // 获取小程序版本号
    if (this.portal === 'miniprogram') {
      Api.getMPVersion()
        .then(res => {
          this.currentMPVersion = res.current_version.version;
        })
        .catch(err => {
          this.currentMPVersion = '0.0.0';
          this.$message({
            message: err.message,
            type: 'error',
          });
        });
    }

    // 请求发现页配置
    this.load();
    // 获得课程分类列表
    this.getCourseCategories();
    // 获得班级分类列表
    this.getClassCategories();
    // 获得题库分类列表
    this.getItemBankCategories();
    // 获得优惠券开关
    this.getCouponSwitch();
  },
  methods: {
    ...mapActions([
      'getCourseCategories',
      'getClassCategories',
      'getItemBankCategories',
      'deleteDraft',
      'saveDraft',
      'getDraft',
    ]),
    getCouponSwitch() {
      Api.getCouponSetting().then(res => {
        this.couponSwitch = parseInt(res.enabled, 10);
      });
    },
    supportVersion(version) {
      return !needUpgrade(version, this.currentMPVersion);
    },
    moduleCountInit() {
      // 模块类型计数初始化
      const typeCount = new ModuleCounter();
      for (let i = 0, len = this.modules.length; i < len; i++) {
        typeCount.addByType(this.modules[i].type);
      }
      this.typeCount = typeCount;
    },
    isActive(index) {
      return index === this.currentModuleIndex;
    },
    activeModule(index) {
      // 激活编辑模块
      this.currentModuleIndex = index;
    },
    updateModule(data, index) {
      // 更新模块
      this.validateResults[index] = data.incomplete;
    },
    removeModule(data, index) {
      // 删除一个模块
      this.typeCount.removeByType(data.type);
      this.currentModuleIndex = Math.max(this.currentModuleIndex - 1, 0);
      this.modules.splice(index, 1);
    },
    addModule(data, index) {
      /*
       * 后台会员组件交互处理:
       * 会员插件未安装：隐藏按钮 (vipSetupStatus)
       * 会员插件未升级：/admin/app/upgrades (vipPlugin)
       * 未开通会员功能：/admin/setting/vip (vipSettings)
       * 开通会员但未配置会员等级：/admin/setting/vip/level (vipLevels)
       */
      switch (data.default.type) {
        case 'vip':
          if (!this.vipSetupStatus) {
            return;
          } else if (needUpgrade('1.7.26', this.vipPlugin.version)) {
            this.$confirm('请升级会员插件', '提示', {
              confirmButtonText: '去升级',
              cancelButtonText: '取消',
            })
              .then(() => {
                window.open(window.location.origin + '/admin/app/upgrades');
              })
              .catch(() => {});
            return;
          } else if (
            !this.vipSettings ||
            !this.vipSettings.enabled ||
            !this.vipSettings.h5Enabled
          ) {
            this.$confirm('会员功能未开通', '提示', {
              confirmButtonText: '去开通',
              cancelButtonText: '取消',
            })
              .then(() => {
                window.open(window.location.origin + 'admin/v2/setting/vip');
              })
              .catch(() => {});
            return;
          } else if (!this.vipLevels || !this.vipLevels.length) {
            this.$confirm('请先设置会员等级', '提示', {
              confirmButtonText: '去设置',
              cancelButtonText: '取消',
            })
              .then(() => {
                window.open(
                  window.location.origin + '/admin/setting/vip/level',
                );
              })
              .catch(() => {});
            return;
          }
          break;
        case 'coupon':
          if (!this.couponSwitch) {
            this.$confirm('优惠券功能未开通', '提示', {
              confirmButtonText: '去开通',
              cancelButtonText: '取消',
            })
              .then(() => {
                window.open(window.location.origin + '/admin/setting/coupon');
              })
              .catch(() => {});
            return;
          }
          break;
        default:
          break;
      }

      // 新增一个模块
      if (this.typeCount.getCounterByType(data.default.type) >= 5) {
        this.$message({
          message: '同一类型组件最多添加 5 个',
          type: 'warning',
        });
        return;
      }
      this.moduleLength = this.moduleLength + 1;
      this.typeCount.addByType(data.default.type);

      const defaultString = JSON.stringify(data.default); // 需要一个深拷贝对象
      const defaultCopied = JSON.parse(defaultString);

      // oldIndex用于组件的key,减少组件重新创建
      defaultCopied.oldIndex = this.moduleLength;

      this.modules.push(defaultCopied);
      this.currentModuleIndex = Math.max(this.modules.length - 1, 0);
    },
    load() {
      // 读取草稿配置
      const mode = this.$route.query.draft == 1 ? 'draft' : 'published';

      this.getDraft({
        portal: this.portal,
        type: 'discovery',
        mode,
      })
        .then(res => {
          // app默认两行展示，这里要手动修改
          Object.keys(res).forEach((element, index) => {
            res[element] = this.formateH5Display(
              res[element].type, // 兼容无displayStyle的老数据
              res[element],
            );
            res[element].oldIndex = index; // oldIndex用于组件的key,减少组件重新创建
          });
          this.moduleLength = Object.keys(res).length - 1;
          this.modules = Object.values(res);
          this.moduleCountInit();
        })
        .catch(err => {
          this.moduleCountInit();
          this.$message({
            message: err.message,
            type: 'error',
          });
        });
    },
    // 处理班级课程排列
    formateH5Display(type, item) {
      if (
        (type === 'course_list' || type === 'classroom_list') &&
        !item.data.displayStyle
      ) {
        if (this.portal === 'app') {
          item.data.displayStyle = 'distichous';
        } else if (this.portal === 'h5') {
          item.data.displayStyle = 'row';
        }
      }
      return item;
    },
    reset() {
      // 删除草稿配置配置
      this.deleteDraft({
        portal: this.portal,
        type: 'discovery',
        mode: 'draft',
      })
        .then(res => {
          this.$message({
            message: '重置成功',
            type: 'success',
          });
          this.load();
        })
        .catch(err => {
          this.$message({
            message: err.message || '重置失败',
            type: 'error',
          });
        });
    },
    save(mode, needTrans = true) {
      this.startValidate = true;
      this.saveFlag++;
      // 验证提交配置
      const validateAndSubmit = () => {
        let data = this.modules;
        const isPublish = mode === 'published';

        this.startValidate = false;

        this.validate();

        // 如果已经是对象就不用转换
        if (needTrans) {
          data = ObjectArray2ObjectByKey(this.modules, 'moduleType');
        }
        if (this.incomplete) {
          return;
        }
        this.saveDraft({
          data,
          mode,
          portal: this.portal,
          type: 'discovery',
        })
          .then(() => {
            this.saveFlag = 0;
            if (isPublish) {
              this.$message({
                message: '发布成功',
                type: 'success',
              });
              return;
            }
            this.$store.commit(types.UPDATE_DRAFT, data);
            this.toPreview(isPublish);
          })
          .catch(err => {
            this.$message({
              message: err.message || '发布失败，请重新尝试',
              type: 'error',
            });
          });
      };
      setTimeout(() => {
        validateAndSubmit();
      }, 500); // 点击 预览／发布 时去验证所有组件，会有延迟，目前 low 的解决方法延迟 500ms 判断验证结果
    },
    toPreview(isPublish) {
      this.$router.push({
        name: 'preview',
        query: {
          times: 10,
          preview: isPublish ? 0 : 1,
          duration: 60 * 5,
          from: this.pathName,
        },
      });
    },
    validate() {
      for (let i = 0; i < this.modules.length; i++) {
        if (this.validateResults[i]) {
          this.incomplete = this.validateResults[i];
          return;
        }
      }
      this.incomplete = false;
    },
  },
};
</script>

(window.webpackJsonp=window.webpackJsonp||[]).push([["marketingWxpay"],{"0538":function(e,t,n){"use strict";n("3751")},"0f06":function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=function(e){return"string"==typeof e},r=function(e){return e instanceof Blob};(function(){"navigator"in this||(this.navigator={}),"function"!=typeof this.navigator.sendBeacon&&(this.navigator.sendBeacon=function(e,t){var n=this.event&&this.event.type,i="unload"===n||"beforeunload"===n,o="XMLHttpRequest"in this?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");o.open("POST",e,!i),o.withCredentials=!0,o.setRequestHeader("Accept","*/*"),a(t)?(o.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),o.responseType="text"):r(t)&&t.type&&o.setRequestHeader("Content-Type",t.type);try{o.send(t)}catch(e){return!1}return!0}.bind(this))}).call("object"===("undefined"==typeof window?"undefined":n(window))?window:{})},3751:function(e,t,n){},8567:function(e,t,n){"use strict";n.r(t);var a=n("c80c"),r=(n("e17f"),n("2241")),i=(n("e7e5"),n("d399")),o=(n("c5f6"),n("96cf"),n("3b8d")),s=n("db72"),c=n("3ce7"),u=n("2f62"),f=(n("0f06"),n("240b")),p={name:"MarketingWXPay",data:function(){return{isLoading:!1,payInfo:null,loginConfig:{},isPay:!1}},computed:Object(s.a)(Object(s.a)({},Object(u.e)({token:function(e){return e.token}})),{},{isWeixinBrowser:function(){return/micromessenger/.test(navigator.userAgent.toLowerCase())}}),created:function(){var e=this;return Object(o.a)(Object(a.a)().mark((function t(){var n,o;return Object(a.a)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(document.title=e.$t("title.confirmPayment"),e.$route.query.loginToken&&(f.a.state.token=e.$route.query.loginToken),e.token){t.next=5;break}return c.a.loginConfig({}).then((function(t){e.loginConfig=t,Number(t.weixinmob_enabled)&&e.isWeixinBrowser&&e.wxLogin()})),t.abrupt("return");case 5:if(n=e.$route.query.payToken||""){t.next=9;break}return i.a.fail("缺少关键信息"),t.abrupt("return");case 9:return t.next=11,c.a.getMarketingMallPayConfig({data:{token:n}});case 11:if(!1!==(o=t.sent).success){t.next=15;break}return r.a.alert({confirmButtonText:"我知道了",confirmButtonColor:"#165DFF",message:o.message}),t.abrupt("return");case 15:e.payInfo=o,e.handlePay(),window.addEventListener("unload",(function(){return e.closeOrder()})),window.addEventListener("pagehide",(function(){return e.closeOrder()}));case 19:case"end":return t.stop()}}),t)})))()},methods:{closeOrder:function(){var e=this;return Object(o.a)(Object(a.a)().mark((function t(){var n;return Object(a.a)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.isPay){t.next=2;break}return t.abrupt("return");case 2:return n="/api/unified_payment/".concat(e.payInfo.tradeSn,"/close_trade"),t.prev=3,t.next=6,fetch(n,{method:"POST",headers:{"X-Auth-Token":f.a.state.token,Accept:"application/vnd.edusoho.v2+json","Content-Type":"application/json"},keepalive:!0});case 6:t.next=11;break;case 8:t.prev=8,t.t0=t.catch(3),console.log(t.t0);case 11:case"end":return t.stop()}}),t,null,[[3,8]])})))()},handleAmount:function(e){return e/100},handlePay:function(){var e=this;return Object(o.a)(Object(a.a)().mark((function t(){var n,i;return Object(a.a)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.$route.query.payToken||"",t.next=3,c.a.checkMarketingMallPayConfig({params:{token:n}});case 3:if(!1!==(i=t.sent).success){t.next=7;break}return r.a.alert({confirmButtonText:"我知道了",confirmButtonColor:"#165DFF",message:i.message}),t.abrupt("return");case 7:WeixinJSBridge.invoke("getBrandWCPayRequest",e.payInfo.config,(function(t){"get_brand_wcpay_request:ok"==t.err_msg?(e.isPay=!0,window.location.href=e.payInfo.redirectUrl+"&isNeedCheckOrderStatus=1&sn=".concat(e.payInfo.orderSn)):"get_brand_wcpay_request:fail"==t.err_msg||t.err_msg}));case 8:case"end":return t.stop()}}),t)})))()},wxLogin:function(){this.$router.push({path:"/auth/social",query:{type:"wx",weixinmob_key:this.loginConfig.weixinmob_key,redirect:this.$route.query.redirect||this.$route.path,callbackType:this.$route.query.callbackType,activityId:this.$route.query.activityId}})}}},d=(n("0538"),n("2877")),l=Object(d.a)(p,(function(){var e=this,t=e._self._c;return e.isWeixinBrowser&&e.payInfo?t("div",{staticClass:"marketing-wxpay"},[t("div",{staticClass:"marketing-wxpay__title"},[e._v(e._s(e.$t("marketingPay.amountLabel")))]),t("div",{staticClass:"marketing-wxpay__amount"},[t("span",{staticClass:"amount-unit"},[e._v("￥")]),t("span",{staticClass:"amount-number"},[e._v(e._s((e.payInfo.amount/100).toFixed(2)))])]),t("div",{staticClass:"marketing-wxpay__info"},[t("div",{staticClass:"info-label"},[e._v(e._s(e.$t("marketingPay.orderSnLabel")))]),t("div",{staticClass:"info-desc"},[e._v(e._s(e.payInfo.orderSn))])]),t("div",{staticClass:"marketing-wxpay__info",staticStyle:{border:"none"}},[t("div",{staticClass:"info-label"},[e._v(e._s(e.$t("marketingPay.acceptLabel")))]),t("div",{staticClass:"info-desc"},[e._v(e._s(e.payInfo.siteName))])]),t("div",{staticClass:"pay-btn",on:{click:e.handlePay}},[e._v("\n    "+e._s(e.$t("marketingPay.payNow"))+"\n  ")])]):e._e()}),[],!1,null,"2d6c2287",null);t.default=l.exports}}]);